<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leilyce nail atelierï½œãƒã‚¤ãƒ«ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ </title>

  <!-- ãƒ­ã‚´ç”¨ï¼šDancing Script / ãƒ•ã‚©ãƒ¼ãƒ ç”¨ï¼šNoto Sans JPï¼ˆã‚´ã‚·ãƒƒã‚¯ï¼‰ -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    :root{
      --brand: #5f95ad;
      --brand2: #9fc9dd;
      --ink: #243645;
      --muted: #5d6d77;
      --card: rgba(255,255,255,0.92);
      --line: #d9e7f0;
      --shadow: rgba(0,0,0,0.08);
    }

    body{
      margin: 0;
      padding: 0 16px;
      font-family: "Noto Sans JP", sans-serif; /* ãƒ•ã‚©ãƒ¼ãƒ ã¯ã‚´ã‚·ãƒƒã‚¯ */
      color: var(--ink);

      /* èƒŒæ™¯ï¼šGitHub Pagesã«ç½®ã watercolor ç”»åƒ */
      background-image: url("./background_blue.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
    }

    .container{
      max-width: 560px;
      margin: 26px auto 70px;
      padding: 26px 18px;
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 10px 30px var(--shadow);
      backdrop-filter: blur(2px);
    }

    /* äºŒæ®µã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ”¹è¡Œï¼‰ */
    .brand{
      text-align: center;
      margin-bottom: 12px;
    }
    .brand .logo{
      font-family: "Dancing Script", cursive; /* ãƒ­ã‚´ã¯ã‚ªã‚·ãƒ£ãƒ³ãƒ†ã‚£ */
      font-size: 42px;
      color: var(--brand);
      margin: 0;
      line-height: 1.05;
      letter-spacing: 0.5px;
    }
    .brand .subtitle{
      margin-top: 8px;
      font-weight: 900;
      color: #3e6272;
      font-size: 16px;
      line-height: 1.2;
    }

    h2{
      font-size: 18px;
      border-left: 4px solid var(--brand2);
      padding-left: 10px;
      margin-top: 26px;
      color: #3e6272;
    }

    label{
      display:block;
      margin-top: 16px;
      font-weight: 900;
      font-size: 14px;
      color: var(--ink);
    }

    input[type="text"], textarea, select, input[type="file"]{
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccd6dd;
      margin-top: 8px;
      background: rgba(255,255,255,0.95);
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }

    .photoPreview{
      margin-top: 12px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--line);
      background: #fff;
      display: none;
    }
    .photoPreview img{
      width: 100%;
      display:block;
    }

    .checkbox-group{
      margin-top: 10px;
      display: grid;
      gap: 10px;
    }
    .checkbox-group label{
      display:flex;
      align-items:center;
      gap: 10px;
      margin: 0;
      font-weight: 500;
      font-size: 15px;
    }
    .checkbox-group input[type="checkbox"]{
      transform: scale(1.2);
    }

    button[type="submit"]{
      margin-top: 22px;
      width: 100%;
      padding: 14px;
      background-color: var(--brand);
      color:#fff;
      font-size: 17px;
      font-weight: 900;
      border:none;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 4px 10px var(--shadow);
    }
    button[type="submit"]:hover{ background-color: #4d859f; }
    button[disabled]{ opacity: 0.7; cursor: not-allowed; }

    .note{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.55;
    }

    .errorBox{
      margin-top: 14px;
      background: #fff3f3;
      border: 1px solid #ffd1d1;
      color: #8b2c2c;
      padding: 12px;
      border-radius: 12px;
      display:none;
      font-size: 14px;
      line-height: 1.6;
    }

    /* çµæœ */
    #result{
      display:none;
      margin-top: 24px;
    }
    .cards{
      display:grid;
      gap: 16px;
      margin-top: 14px;
    }
    .card{
      background: rgba(250,253,255,0.96);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }
    .cardHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid #e3eef5;
    }
    .badge{
      display:inline-block;
      font-size: 12px;
      font-weight: 900;
      color: #3e6272;
      background: #e7f3f9;
      border: 1px solid #cfe7f4;
      padding: 5px 10px;
      border-radius: 999px;
    }
    .cardTitle{
      margin: 10px 0 6px;
      font-size: 16px;
      font-weight: 900;
      color: var(--ink);
    }
    .meta{
      font-size: 13px;
      color: #51636f;
      line-height: 1.5;
    }
    .imgWrap{
      background:#fff;
      border-top: 1px solid #e3eef5;
      border-bottom: 1px solid #e3eef5;
    }
    .imgWrap img{
      width: 100%;
      display:block;
    }
    .cardBody{
      padding: 14px;
    }
    .plan{
      white-space: pre-wrap;
      background: #eef7fb;
      border-left: 4px solid var(--brand2);
      border-radius: 12px;
      padding: 12px;
      font-size: 13px;
      line-height: 1.65;
      color: #20313f;
      margin: 10px 0 0;
    }
    details{
      margin-top: 10px;
    }
    summary{
      cursor:pointer;
      font-weight: 900;
      color: #3e6272;
    }
    .imgFail{
      padding: 12px 14px;
      font-size: 12px;
      color: #8b2c2c;
      background: #fff3f3;
      border-top: 1px solid #ffd1d1;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆsubmitæ™‚ã ã‘è¡¨ç¤ºï¼‰ */
    #loadingPopup{
      display:none;           /* â† åˆæœŸã¯çµ¶å¯¾å‡ºã•ãªã„ */
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background-color: rgba(255,255,255,0.92);
      z-index:9999;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .loadingBox{
      width: min(420px, 92vw);
      background: rgba(255,255,255,0.98);
      border: 1px solid #dbe8f0;
      border-radius: 16px;
      padding: 18px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      text-align:center;
    }
    .loadingTitle{
      color: var(--brand);
      font-weight: 900;
      font-size: 18px;
      margin: 4px 0 6px;
    }
    .loadingSub{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      margin: 0;
    }
    .spinner{
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 4px solid #cfe3ee;
      border-top-color: var(--brand);
      margin: 14px auto 10px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="container">
    <div class="brand">
      <!-- äºŒæ®µï¼ˆæ”¹è¡Œï¼‰ -->
      <h1 class="logo">Leilyce nail atelier</h1>
      <div class="subtitle">ãƒã‚¤ãƒ«ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ </div>
    </div>

    <form id="nailForm" novalidate>
      <h2>çˆªã®å†™çœŸï¼ˆå¿…é ˆï¼‰</h2>

      <label for="nail_photo">ã‚ãªãŸã®çˆªã®å†™çœŸï¼ˆå¿…é ˆï¼‰</label>
      <input
        type="file"
        id="nail_photo"
        name="nail_photo"
        accept="image/*"
        capture="environment"
        required
      />
      <div class="hint">
        â€»ã‚¹ãƒãƒ›ã®å ´åˆã€ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã™ã€‚æ˜ã‚‹ã„å ´æ‰€ã§ã€çˆªå…ˆã€œæŒ‡å…ˆãŒã¯ã£ãã‚Šå†™ã‚‹è·é›¢ã§æ’®å½±ã—ã¦ãã ã•ã„ã€‚<br>
        â€»ãƒ”ãƒ³ãƒˆãŒåˆã‚ãªã„å ´åˆã¯ã€å°‘ã—é›¢ã—ã¦æ’®ã‚Šç›´ã™ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
      </div>

      <div class="photoPreview" id="photoPreview">
        <img id="photoPreviewImg" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
      </div>

      <h2>åŸºæœ¬æƒ…å ±</h2>

      <label for="age">å¹´é½¢å±¤</label>
      <select id="age" name="age">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="10ä»£">10ä»£</option>
        <option value="20ä»£">20ä»£</option>
        <option value="30ä»£">30ä»£</option>
        <option value="40ä»£">40ä»£</option>
        <option value="50ä»£ä»¥ä¸Š">50ä»£ä»¥ä¸Š</option>
      </select>

      <label for="lifestyle">è·æ¥­ã‚„ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</label>
      <input type="text" id="lifestyle" name="lifestyle" placeholder="ä¾‹ï¼šã‚ªãƒ•ã‚£ã‚¹ãƒ¯ãƒ¼ã‚¯ã€æ¥å®¢æ¥­ã€åœ¨å®…ãƒ¯ãƒ¼ã‚¯ ãªã©"/>

      <label for="nail_duration">ä»–ã‚µãƒ­ãƒ³ã§ã®ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«ã®æŒã¡ã¯ã©ã®ãã‚‰ã„ã§ã—ãŸã‹ï¼Ÿï¼ˆä»»æ„ï¼‰</label>
      <select id="nail_duration" name="nail_duration">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="1é€±é–“æœªæº€">1é€±é–“æœªæº€</option>
        <option value="1ã€œ2é€±é–“">1ã€œ2é€±é–“</option>
        <option value="2ã€œ3é€±é–“">2ã€œ3é€±é–“</option>
        <option value="3ã€œ4é€±é–“">3ã€œ4é€±é–“</option>
        <option value="4é€±é–“ä»¥ä¸Š">4é€±é–“ä»¥ä¸Š</option>
        <option value="è¦šãˆã¦ã„ãªã„">è¦šãˆã¦ã„ãªã„</option>
      </select>

      <h2>ãƒã‚¤ãƒ«ã®å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸</h2>

      <label>ä»Šå›ã®ãƒã‚¤ãƒ«ã®ç›®çš„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="purpose" value="ä»•äº‹ç”¨"> ä»•äº‹ã«åˆã‚ã›ã¦</label>
        <label><input type="checkbox" name="purpose" value="æ°—åˆ†è»¢æ›"> æ°—åˆ†ã‚’ä¸Šã’ãŸã„</label>
        <label><input type="checkbox" name="purpose" value="ã‚¤ãƒ™ãƒ³ãƒˆ"> ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—…è¡Œãƒ»æ¨ã—æ´»ãªã©ï¼‰</label>
        <label><input type="checkbox" name="purpose" value="äººã¨ä¼šã†"> äººã¨ä¼šã†äºˆå®šãŒã‚ã‚‹</label>
        <label><input type="checkbox" name="purpose" value="ãªã‚“ã¨ãªã"> ãªã‚“ã¨ãªãã‚­ãƒ¬ã‚¤ã«ã—ãŸã„</label>
      </div>

      <label>å¸Œæœ›ã™ã‚‹ãƒã‚¤ãƒ«ã®é›°å›²æ°—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="vibe" value="ä¸Šå“"> ä¸Šå“</label>
        <label><input type="checkbox" name="vibe" value="å¯æ„›ã„"> å¯æ„›ã„</label>
        <label><input type="checkbox" name="vibe" value="å¤§äººã£ã½ã„"> å¤§äººã£ã½ã„</label>
        <label><input type="checkbox" name="vibe" value="ãƒŠãƒãƒ¥ãƒ©ãƒ«"> ãƒŠãƒãƒ¥ãƒ©ãƒ«</label>
        <label><input type="checkbox" name="vibe" value="ã‚¯ãƒ¼ãƒ«"> ã‚¯ãƒ¼ãƒ«</label>
        <label><input type="checkbox" name="vibe" value="ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿ"> ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿã‚ã‚‹</label>
        <label><input type="checkbox" name="vibe" value="è‡ªåˆ†ã‚‰ã—ã"> è‡ªåˆ†ã‚‰ã—ã</label>
      </div>

      <label for="avoid_colors">è‹¦æ‰‹ãƒ»é¿ã‘ãŸã„ãƒ†ã‚¤ã‚¹ãƒˆã‚„ã‚«ãƒ©ãƒ¼ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
      <textarea id="avoid_colors" name="avoid_colors" rows="3" placeholder="ä¾‹ï¼šæ´¾æ‰‹ãªèµ¤ã€ãƒ©ãƒ¡ã€é»’ç³»ãŒè‹¦æ‰‹..."></textarea>

      <button id="submitBtn" type="submit">é€ä¿¡ã™ã‚‹</button>

      <div class="note">
        â€»å†™çœŸã¯å¿…é ˆã§ã™ï¼ˆã‚¹ãƒãƒ›ã‚«ãƒ¡ãƒ©æ¨å¥¨ï¼‰ã€‚<br>
        â€»çµæœã¯ã€Œ3ãƒ‘ã‚¿ãƒ¼ãƒ³ææ¡ˆï¼ˆç”»åƒï¼‹ãƒ—ãƒ©ãƒ³ï¼‰ã€ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>

      <div class="errorBox" id="errorBox"></div>
    </form>

    <div id="result">
      <h2>ã‚ãªãŸã¸ã®ææ¡ˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰</h2>
      <div class="cards" id="cards"></div>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆsubmitæ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
  <div id="loadingPopup">
    <div class="loadingBox">
      <div class="loadingTitle">å‡¦ç†ä¸­ã§ã™â€¦ ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ ğŸ’…</div>
      <div class="spinner"></div>
      <p class="loadingSub">
        ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å†…å®¹ã‹ã‚‰ã€3ç¨®é¡ã®ææ¡ˆã¨ç”»åƒã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<br>
        é€šä¿¡ç’°å¢ƒã«ã‚ˆã‚Šå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
      </p>
    </div>
  </div>

  <script>
    // â˜…Renderã®URLã«åˆã‚ã›ã¦è¨­å®šï¼ˆç¾çŠ¶ã®ã¾ã¾ã§OKãªã‚‰è§¦ã‚‰ãªã„ï¼‰
    const API_BASE = "https://makeup-enz8.onrender.com";
    const ENDPOINT = "/api/makeup"; // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ /api/makeup ã®å ´åˆ

    const formEl = document.getElementById("nailForm");
    const popup = document.getElementById("loadingPopup");
    const submitBtn = document.getElementById("submitBtn");
    const errorBox = document.getElementById("errorBox");

    const resultEl = document.getElementById("result");
    const cardsEl = document.getElementById("cards");

    const photoInput = document.getElementById("nail_photo");
    const previewWrap = document.getElementById("photoPreview");
    const previewImg = document.getElementById("photoPreviewImg");

    // å¿µã®ãŸã‚ï¼šãƒ­ãƒ¼ãƒ‰æ™‚ã¯å¿…ãšéè¡¨ç¤ºï¼ˆâ€œé–‹ã„ãŸç¬é–“ãšã£ã¨å‡¦ç†ä¸­â€å¯¾ç­–ï¼‰
    window.addEventListener("DOMContentLoaded", () => {
      popup.style.display = "none";
    });

    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file) {
        previewWrap.style.display = "none";
        previewImg.src = "";
        return;
      }
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewWrap.style.display = "block";
    });

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
    }
    function clearError() {
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    function escapeHTML(str) {
      return (str || "").replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    function cardHTML(p, idx) {
      const palette = Array.isArray(p.palette) ? p.palette.join(" / ") : "";
      const style = p.style || p.style_axis || "";
      const title = p.name || `ææ¡ˆ ${idx + 1}`;

      return `
        <div class="card">
          <div class="cardHeader">
            <span class="badge">${escapeHTML(style || `ææ¡ˆ ${idx + 1}`)}</span>
            <div class="cardTitle">${escapeHTML(title)}</div>
            <div class="meta">
              <div><b>ã‚«ãƒ©ãƒ¼</b>ï¼š${escapeHTML(palette)}</div>
              <div><b>ãƒ‡ã‚¶ã‚¤ãƒ³</b>ï¼š${escapeHTML(p.design || "")}</div>
              <div><b>ãŠã™ã™ã‚ç†ç”±</b>ï¼š${escapeHTML(p.why || p.why_fit || "")}</div>
            </div>
          </div>

          ${
            p.image_url
              ? `<div class="imgWrap">
                   <img src="${escapeHTML(p.image_url)}" alt="ãƒã‚¤ãƒ«ã‚µãƒ³ãƒ—ãƒ«ç”»åƒ"
                        onerror="this.closest('.imgWrap').innerHTML='';" />
                 </div>`
              : `<div class="imgFail">ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ—ãƒ©ãƒ³ã¯è¡¨ç¤ºã§ãã¾ã™ï¼‰</div>`
          }

          <div class="cardBody">
            <details open>
              <summary>ãƒ—ãƒ©ãƒ³ã‚’è¦‹ã‚‹</summary>
              <pre class="plan">${escapeHTML(p.plan || "")}</pre>
            </details>
          </div>
        </div>
      `;
    }

    formEl.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearError();

      // ã‚«ãƒ¡ãƒ©å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆrequiredè£œåŠ©ï¼‰
      if (!photoInput.files || !photoInput.files[0]) {
        showError("çˆªã®å†™çœŸãŒæœªé¸æŠã§ã™ã€‚æ’®å½±ï¼ˆã¾ãŸã¯é¸æŠï¼‰ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆsubmitæ™‚ã®ã¿ï¼‰
      popup.style.display = "flex";
      submitBtn.disabled = true;
      submitBtn.textContent = "é€ä¿¡ä¸­...";

      try {
        // FormDataï¼ˆç”»åƒ + ãƒ†ã‚­ã‚¹ãƒˆ + checkboxè¤‡æ•°ï¼‰ã§é€ã‚‹
        const fd = new FormData(formEl);

        const res = await fetch(`${API_BASE}${ENDPOINT}`, {
          method: "POST",
          body: fd
        });

        const ct = res.headers.get("content-type") || "";
        const payload = ct.includes("application/json") ? await res.json() : null;

        if (!res.ok) {
          throw new Error(payload?.error || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
        }

        // æœŸå¾…å½¢å¼ï¼š{ status: "ok", proposals: [...] }
        const proposals = payload?.proposals;

        if (!Array.isArray(proposals) || proposals.length === 0) {
          throw new Error("ææ¡ˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆproposals ãŒç©ºï¼‰");
        }

        // 3æ¡ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        cardsEl.innerHTML = proposals.slice(0, 3).map((p, i) => cardHTML(p, i)).join("");
        resultEl.style.display = "block";

        // ãƒ•ã‚©ãƒ¼ãƒ ã¯éš ã™ï¼ˆæˆ»ã™ãƒœã‚¿ãƒ³ã‚’ä»˜ã‘ãŸã„ãªã‚‰è¨€ã£ã¦ï¼‰
        formEl.style.display = "none";

      } catch (err) {
        console.error(err);
        showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${err.message}`);
      } finally {
        popup.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.textContent = "é€ä¿¡ã™ã‚‹";
      }
    });
  </script>
</body>
</html>
