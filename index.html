<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leilyce nail atelierï½œãƒã‚¤ãƒ«ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ </title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0 16px;
      font-family: 'Noto Sans JP', sans-serif;
      color: #2d3e50;

      /* âœ… GitHub Pagesï¼šãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã« background_blue.png ã‚’ç½®ãæƒ³å®š */
      background-image: url("./background_blue.png");
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
    }

    .container {
      max-width: 520px;
      margin: 28px auto 60px;
      padding: 28px 18px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      backdrop-filter: blur(2px);
    }

    .brand {
      text-align: center;
      margin-bottom: 18px;
    }
    .brand .logo {
      font-family: 'Dancing Script', cursive;
      font-size: 40px;
      color: #6fa0b7;
      line-height: 1.1;
      margin: 0;
    }
    .brand .title {
      font-weight: 700;
      color: #476877;
      margin-top: 6px;
      font-size: 16px;
    }

    h2 {
      font-size: 18px;
      border-left: 4px solid #a7cbdc;
      padding-left: 10px;
      margin-top: 26px;
      color: #476877;
    }

    label {
      display: block;
      margin-top: 16px;
      font-weight: 700;
      font-size: 14px;
      color: #2d3e50;
    }

    input[type="text"], textarea, select, input[type="file"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccd6dd;
      margin-top: 8px;
      background: rgba(255,255,255,0.95);
    }

    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #5f6f7a;
      line-height: 1.5;
    }

    .checkbox-group {
      margin-top: 10px;
      display: grid;
      gap: 10px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
      font-weight: 400;
      font-size: 15px;
    }

    .checkbox-group input[type="checkbox"] {
      transform: scale(1.2);
    }

    button[type="submit"] {
      margin-top: 22px;
      width: 100%;
      padding: 14px;
      background-color: #6fa0b7;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    button[type="submit"]:hover {
      background-color: #5a8ea6;
    }
    button[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .result {
      margin-top: 26px;
      padding: 18px;
      background: rgba(249, 252, 255, 0.96);
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .result h2 {
      margin-top: 0;
    }

    .result pre {
      white-space: pre-wrap;
      background: #eef7fb;
      padding: 14px;
      border-left: 4px solid #aad4ec;
      border-radius: 10px;
      margin: 12px 0 0;
      font-size: 14px;
      line-height: 1.65;
    }

    .preview {
      margin-top: 14px;
      display: none;
      border-radius: 12px;
      border: 1px solid #d7e2ea;
      overflow: hidden;
      background: #fff;
    }
    .preview img {
      width: 100%;
      display: block;
    }

    .caption {
      text-align: center;
      font-size: 12px;
      color: #6b7b86;
      margin-top: 8px;
    }

    #loadingPopup {
      display: none; /* åˆæœŸã¯çµ¶å¯¾éè¡¨ç¤º */
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.92);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    .loadingBox {
      width: min(420px, 92vw);
      background: rgba(255,255,255,0.98);
      border: 1px solid #dbe8f0;
      border-radius: 16px;
      padding: 18px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      text-align: center;
    }
    .loadingTitle {
      color: #6fa0b7;
      font-weight: 800;
      font-size: 18px;
      margin: 4px 0 6px;
    }
    .loadingSub {
      color: #5f6f7a;
      font-size: 13px;
      line-height: 1.6;
      margin: 0;
    }
    .spinner {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 4px solid #cfe3ee;
      border-top-color: #6fa0b7;
      margin: 14px auto 10px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .errorBox {
      margin-top: 14px;
      background: #fff3f3;
      border: 1px solid #ffd1d1;
      color: #8b2c2c;
      padding: 12px;
      border-radius: 12px;
      display: none;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="brand">
      <h1 class="logo">Leilyce nail atelier</h1>
      <div class="title">ãƒã‚¤ãƒ«ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ </div>
    </div>

    <form id="nailForm">
      <h2>å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

      <label for="nail_photo">è‡ªåˆ†ã®çˆªã®å†™çœŸï¼ˆã‚«ãƒ¡ãƒ©ã§æ’®å½±OKï¼‰</label>
      <input id="nail_photo" name="nail_photo" type="file" accept="image/*" capture="environment" required />
      <div class="hint">
        ãƒ»æ˜ã‚‹ã„å ´æ‰€ã§ã€çˆªãŒã¯ã£ãã‚Šå†™ã‚‹ã‚ˆã†ã«æ’®ã‚‹ã¨ç²¾åº¦UP<br>
        ãƒ»æ‰‹å…¨ä½“ã‚ˆã‚Šã€ŒæŒ‡å…ˆã€œçˆªã€ãŒå¤§ãã‚ã«å†™ã£ã¦ã„ã‚‹ã¨è‰¯ã„ã§ã™
      </div>

      <h2>åŸºæœ¬æƒ…å ±</h2>

      <label for="age">å¹´é½¢å±¤</label>
      <select id="age" name="age">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="10ä»£">10ä»£</option>
        <option value="20ä»£">20ä»£</option>
        <option value="30ä»£">30ä»£</option>
        <option value="40ä»£">40ä»£</option>
        <option value="50ä»£ä»¥ä¸Š">50ä»£ä»¥ä¸Š</option>
      </select>

      <label for="lifestyle">è·æ¥­ã‚„ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</label>
      <input type="text" id="lifestyle" name="lifestyle" placeholder="ä¾‹ï¼šã‚ªãƒ•ã‚£ã‚¹ãƒ¯ãƒ¼ã‚¯ã€æ¥å®¢æ¥­ã€åœ¨å®…ãƒ¯ãƒ¼ã‚¯ ãªã©"/>

      <label for="nail_duration">ä»–ã‚µãƒ­ãƒ³ã§ã®ã‚¸ã‚§ãƒ«ãƒã‚¤ãƒ«ã®æŒã¡ã¯ã©ã®ãã‚‰ã„ã§ã—ãŸã‹ï¼Ÿï¼ˆä»»æ„ï¼‰</label>
      <select id="nail_duration" name="nail_duration">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="1é€±é–“æœªæº€">1é€±é–“æœªæº€</option>
        <option value="1ã€œ2é€±é–“">1ã€œ2é€±é–“</option>
        <option value="2ã€œ3é€±é–“">2ã€œ3é€±é–“</option>
        <option value="3ã€œ4é€±é–“">3ã€œ4é€±é–“</option>
        <option value="4é€±é–“ä»¥ä¸Š">4é€±é–“ä»¥ä¸Š</option>
        <option value="è¦šãˆã¦ã„ãªã„">è¦šãˆã¦ã„ãªã„</option>
      </select>

      <h2>ãƒã‚¤ãƒ«ã®å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸</h2>

      <label>ä»Šå›ã®ãƒã‚¤ãƒ«ã®ç›®çš„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="purpose" value="ä»•äº‹ç”¨"> ä»•äº‹ã«åˆã‚ã›ã¦</label>
        <label><input type="checkbox" name="purpose" value="æ°—åˆ†è»¢æ›"> æ°—åˆ†ã‚’ä¸Šã’ãŸã„</label>
        <label><input type="checkbox" name="purpose" value="ã‚¤ãƒ™ãƒ³ãƒˆ"> ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—…è¡Œãƒ»æ¨ã—æ´»ãªã©ï¼‰</label>
        <label><input type="checkbox" name="purpose" value="äººã¨ä¼šã†"> äººã¨ä¼šã†äºˆå®šãŒã‚ã‚‹</label>
        <label><input type="checkbox" name="purpose" value="ãªã‚“ã¨ãªã"> ãªã‚“ã¨ãªãã‚­ãƒ¬ã‚¤ã«ã—ãŸã„</label>
      </div>

      <label>å¸Œæœ›ã™ã‚‹ãƒã‚¤ãƒ«ã®é›°å›²æ°—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="vibe" value="ä¸Šå“"> ä¸Šå“</label>
        <label><input type="checkbox" name="vibe" value="å¯æ„›ã„"> å¯æ„›ã„</label>
        <label><input type="checkbox" name="vibe" value="å¤§äººã£ã½ã„"> å¤§äººã£ã½ã„</label>
        <label><input type="checkbox" name="vibe" value="ãƒŠãƒãƒ¥ãƒ©ãƒ«"> ãƒŠãƒãƒ¥ãƒ©ãƒ«</label>
        <label><input type="checkbox" name="vibe" value="ã‚¯ãƒ¼ãƒ«"> ã‚¯ãƒ¼ãƒ«</label>
        <label><input type="checkbox" name="vibe" value="ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿ"> ãƒˆãƒ¬ãƒ³ãƒ‰æ„Ÿã‚ã‚‹</label>
        <label><input type="checkbox" name="vibe" value="è‡ªåˆ†ã‚‰ã—ã"> è‡ªåˆ†ã‚‰ã—ã</label>
      </div>

      <label for="avoid_colors">è‹¦æ‰‹ãƒ»é¿ã‘ãŸã„ãƒ†ã‚¤ã‚¹ãƒˆã‚„ã‚«ãƒ©ãƒ¼ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
      <textarea id="avoid_colors" name="avoid_colors" rows="3" placeholder="ä¾‹ï¼šæ´¾æ‰‹ãªèµ¤ã€ãƒ©ãƒ¡ã€é»’ç³»ãŒè‹¦æ‰‹..."></textarea>

      <button id="submitBtn" type="submit">é€ä¿¡ã™ã‚‹</button>

      <div class="errorBox" id="errorBox"></div>
    </form>

    <div class="result" id="result" style="display:none;">
      <h2>ã‚ãªãŸã®ãƒã‚¤ãƒ«ãƒ—ãƒ©ãƒ³</h2>
      <pre id="planText"></pre>

      <div class="preview" id="previewBox">
        <img id="nailImage" src="" alt="ãƒã‚¤ãƒ«è©¦ç€çµæœ" />
      </div>
      <div class="caption" id="imgCaption" style="display:none;">â€»AIã«ã‚ˆã‚‹ãƒã‚¤ãƒ«è©¦ç€ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆçˆªãƒ‡ã‚¶ã‚¤ãƒ³ã®ã¿å¤‰æ›´ï¼‰</div>
    </div>
  </div>

  <!-- å‡¦ç†ä¸­ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="loadingPopup">
    <div class="loadingBox">
      <div class="loadingTitle">å‡¦ç†ä¸­ã§ã™â€¦ ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ ğŸ’…</div>
      <div class="spinner"></div>
      <p class="loadingSub">
        ç”»åƒã®è§£æã¨ãƒ‡ã‚¶ã‚¤ãƒ³ç”Ÿæˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚<br>
        é€šä¿¡ç’°å¢ƒã«ã‚ˆã‚Šå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
      </p>
    </div>
  </div>

  <script>
    const API_BASE = "https://makeup-enz8.onrender.com";

    const formEl = document.getElementById("nailForm");
    const popup = document.getElementById("loadingPopup");
    const submitBtn = document.getElementById("submitBtn");
    const errorBox = document.getElementById("errorBox");

    const resultDiv = document.getElementById("result");
    const planText = document.getElementById("planText");

    const previewBox = document.getElementById("previewBox");
    const nailImage = document.getElementById("nailImage");
    const imgCaption = document.getElementById("imgCaption");

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = "block";
    }
    function clearError() {
      errorBox.textContent = "";
      errorBox.style.display = "none";
    }

    formEl.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearError();

      // ç”»åƒå¿…é ˆãƒã‚§ãƒƒã‚¯
      const fileInput = document.getElementById("nail_photo");
      if (!fileInput.files || fileInput.files.length === 0) {
        showError("çˆªã®å†™çœŸã‚’é¸æŠï¼ˆã¾ãŸã¯æ’®å½±ï¼‰ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // UI: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      popup.style.display = "flex";
      submitBtn.disabled = true;
      submitBtn.textContent = "é€ä¿¡ä¸­...";

      // multipart/form-data
      const fd = new FormData(formEl);

      try {
        const res = await fetch(`${API_BASE}/api/tryon`, {
          method: "POST",
          body: fd
        });

        // JSONä»¥å¤–ãŒè¿”ã£ã¦ããŸã¨ãã«è½ã¡ãªã„ã‚ˆã†ã«ä¿é™º
        let data = null;
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
          data = await res.json();
        } else {
          const text = await res.text();
          throw new Error(`ã‚µãƒ¼ãƒãƒ¼ãŒJSONä»¥å¤–ã‚’è¿”ã—ã¾ã—ãŸ: ${text.slice(0, 200)}`);
        }

        if (!res.ok) {
          throw new Error(data?.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
        }

        // è¡¨ç¤º
        planText.textContent = data.plan || "(ãƒ—ãƒ©ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ)";
        if (data.image_base64) {
          nailImage.src = `data:image/png;base64,${data.image_base64}`;
          previewBox.style.display = "block";
          imgCaption.style.display = "block";
        } else {
          previewBox.style.display = "none";
          imgCaption.style.display = "none";
        }

        resultDiv.style.display = "block";
        formEl.style.display = "none";

      } catch (err) {
        console.error(err);
        showError(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š${err.message}`);
      } finally {
        popup.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.textContent = "é€ä¿¡ã™ã‚‹";
      }
    });
  </script>
</body>
</html>
